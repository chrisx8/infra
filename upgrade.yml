- name: Upgrade proxmox
  hosts: proxmox
  become: true
  tasks:
    - name: Upgrade
      ansible.builtin.import_role:
        name: sys/proxmox
        tasks_from: upgrade.yml
    - name: Install SSL cert for Proxmox
      ansible.builtin.import_role:
        name: sys/proxmox
        tasks_from: ssl_cert.yml

- name: Upgrade guests
  hosts: guests
  gather_facts: true
  gather_subset: ['!min', 'distribution']
  become: true
  tasks:
    - name: Upgrade packages (dnf)
      ansible.builtin.dnf:
        name: "*"
        update_cache: true
        state: latest
      when: "ansible_facts.os_family == 'RedHat'"
    - name: Autoremove unneeded packages (dnf)
      ansible.builtin.dnf:
        autoremove: true
      when: "ansible_facts.os_family == 'RedHat'"

- name: Deploy SSL certs
  hosts: all
  become: true
  tasks:
    - name: Check if chrisx.xyz cert exists
      ansible.builtin.stat:
        path: /etc/ssl/chrisx.xyz
      register: ssl_check
    - name: Check if arb.chrisx.xyz cert exists
      ansible.builtin.stat:
        path: /etc/ssl/arb.chrisx.xyz
      register: arb_ssl_check
    - name: Install chrisx.xyz cert
      ansible.builtin.import_role:
        name: inf/ssl
        tasks_from: chrisx.yml
      when: ssl_check.stat.exists
    - name: Install arb.chrisx.xyz cert
      ansible.builtin.import_role:
        name: inf/ssl
        tasks_from: arb.yml
      when: arb_ssl_check.stat.exists

- name: Fix db-postgres
  hosts: db-postgres
  become: true
  tasks:
    - name: Fix cert permission
      ansible.builtin.file:
        path: /etc/ssl/arb.chrisx.xyz
        owner: postgres
        group: postgres
        recurse: true

- name: Upgrade storage
  hosts: storage
  gather_facts: true
  gather_subset: ['!min', 'distribution']
  become: true
  roles:
    - app/jellyfin
  tasks:
    - name: Install SSL cert for Cockpit
      ansible.builtin.import_role:
        name: inf/cockpit
        tasks_from: ssl_cert.yml

- name: Upgrade containers
  hosts: web-container
  become: true
  roles:
    - app/containers

- name: Upgrade php apps
  hosts: web-php
  become: true
  roles:
    - app/nextcloud
    - app/tinynet_launcher
