- name: Upgrade proxmox
  hosts: proxmox
  become: true
  tasks:
    - name: Upgrade
      ansible.builtin.import_role:
        name: system_pve
        tasks_from: upgrade.yml
    - name: Install SSL cert for Proxmox
      ansible.builtin.import_role:
        name: system_pve
        tasks_from: ssl_cert.yml

- name: Upgrade guests
  hosts: guests
  gather_facts: true
  gather_subset:
    - "!min"
    - "distribution"
  become: true
  tasks:
    - name: Upgrade packages (dnf)
      ansible.builtin.dnf:
        name: "*"
        update_cache: true
        state: latest
      when: ansible_facts.os_family == 'RedHat'
    - name: Autoremove unneeded packages (dnf)
      ansible.builtin.dnf:
        autoremove: true
      when: ansible_facts.os_family == 'RedHat'

- name: Upgrade pihole
  hosts: pihole
  become: true
  roles:
    - static_sites

- name: Upgrade postgres
  hosts: postgres
  become: true
  tasks:
    - name: Install ssl cert
      ansible.builtin.import_role:
        name: postgresql
        tasks_from: sslcert.yml

- name: Upgrade storage
  hosts: storage
  gather_facts: true
  gather_subset:
    - "!min"
    - "distribution"
    - "virtualization_type"
  become: true
  roles:
    - containers_storage
  tasks:
    - name: Install SSL cert for Cockpit
      ansible.builtin.import_role:
        name: cockpit
        tasks_from: ssl_cert.yml

- name: Upgrade containers
  hosts: v-containers
  become: true
  gather_facts: true
  gather_subset:
    - "!min"
    - "distribution"
    - "virtualization_type"
  roles:
    - containers_web
