- name: Prompts
  hosts: localhost
  gather_facts: false
  vars_prompt:
    - name: upgrade_launcher
      prompt: "Upgrade Launcher? (y/n)"
      private: false
    - name: upgrade_containers
      prompt: "Upgrade containers? (y/n)"
      private: false
    - name: upgrade_php_apps
      prompt: "Upgrade PHP applications? (y/n)"
      private: false
  tasks:
    - name: Store prompt inputs
      ansible.builtin.set_fact:
        upgrade_launcher: "{{ upgrade_launcher }}"
        upgrade_containers: "{{ upgrade_containers }}"
        upgrade_php_apps: "{{ upgrade_php_apps }}"

- name: Upgrade system
  hosts: all
  gather_facts: false
  become: true
  tasks:
    - ansible.builtin.import_tasks: tasks/apt_upgrade.yml
    - ansible.builtin.import_tasks: tasks/apt_post.yml
    - name: Check if chrisx.xyz SSL cert exists
      ansible.builtin.stat:
        path: /etc/ssl/chrisx.xyz
      register: ssl_check
    - ansible.builtin.import_tasks: tasks/ssl_cert.yml
      when: ssl_check.stat.exists
    - name: Check if arb.chrisx.xyz SSL cert exists
      ansible.builtin.stat:
        path: /etc/ssl/arb.chrisx.xyz
      register: arb_ssl_check
    - ansible.builtin.import_tasks: tasks/ssl_cert_arb.yml
      when: arb_ssl_check.stat.exists

- name: Upgrade cert on storage
  hosts: storage
  gather_facts: false
  become: true
  tasks:
    - name: Install SSL cert for Cockpit
      ansible.builtin.import_role:
        name: storage
        tasks_from: cockpit_ssl.yml

- name: Set up Postgres databases
  hosts: db-postgres
  gather_facts: false
  become: true
  become_user: postgres
  tasks:
    - name: Set up Postgres databases for container apps
      ansible.builtin.import_role:
        name: app/containers
        tasks_from: create_postgres_db.yml
      when: hostvars['localhost']['upgrade_containers'] == 'y'
    - name: Set up Postgres databases for Firefly III
      ansible.builtin.import_role:
        name: app/firefly-iii
        tasks_from: create_postgres_db.yml
      when: hostvars['localhost']['upgrade_php_apps'] == 'y'

- name: Upgrade containers
  hosts: web-docker
  become: true
  tasks:
    - name: Install container apps
      ansible.builtin.import_role:
        name: app/containers
      when: hostvars['localhost']['upgrade_containers'] == 'y'
    - name: Reload Nginx
      ansible.builtin.command: "docker exec nginx nginx -s reload"
      when: hostvars['localhost']['upgrade_containers'] == 'y'

- name: Upgrade PHP apps
  hosts: web-php
  gather_facts: false
  become: true
  tasks:
    - name: Install launcher
      ansible.builtin.import_role:
        name: app/launcher
      when: hostvars['localhost']['upgrade_launcher'] == 'y'
    - name: Install Composer
      ansible.builtin.import_role:
        name: inf/apache_php
        tasks_from: composer.yml
      when: hostvars['localhost']['upgrade_php_apps'] == 'y'
    - name: Install Firefly III
      ansible.builtin.import_role:
        name: app/firefly-iii
      when: hostvars['localhost']['upgrade_php_apps'] == 'y'
