---
- name: Prompts
  hosts: localhost
  gather_facts: no
  vars_prompt:
    - name: upgrade_dashboard
      prompt: "Upgrade dashboard? (y/n)"
      private: no
    - name: upgrade_containers
      prompt: "Upgrade containers? (y/n)"
      private: no
    - name: upgrade_php_apps
      prompt: "Upgrade PHP applications? (y/n)"
      private: no
  tasks:
  - name: Store prompt inputs
    set_fact:
      upgrade_dashboard: "{{ upgrade_dashboard }}"
      upgrade_containers: "{{ upgrade_containers }}"
      upgrade_php_apps: "{{ upgrade_php_apps }}"

- name: Upgrade system
  hosts: all
  gather_facts: no
  become: yes
  tasks:
    - name: apt dist-upgrade
      apt:
        update_cache: yes
        upgrade: dist
    - import_tasks: tasks/apt_post.yml
    - name: Check if SSL cert exists
      stat:
        path: /etc/ssl/private/fullchain.pem
      register: ssl_check
    - import_tasks: tasks/ssl_cert.yml
      when: ssl_check.stat.exists
    - name: Check if arb SSL cert exists
      stat:
        path: /etc/ssl/private/arb.fullchain.pem
      register: arb_ssl_check
    - import_tasks: tasks/ssl_cert_arb.yml
      when: arb_ssl_check.stat.exists

- name: Set up Postgres databases
  hosts: db-postgres
  gather_facts: no
  become: yes
  become_user: postgres
  tasks:
  - import_role:
      name: containers
      tasks_from: create_postgres_db.yml
    when: hostvars['localhost']['upgrade_containers'] == 'y'
  - import_role:
      name: firefly-iii
      tasks_from: create_postgres_db.yml
    when: hostvars['localhost']['upgrade_php_apps'] == 'y'
  - import_role:
      name: kanboard
      tasks_from: create_postgres_db.yml
    when: hostvars['localhost']['upgrade_php_apps'] == 'y'

- name: Upgrade containers
  hosts: apps01
  become: yes
  tasks:
    - import_role:
        name: containers
      when: hostvars['localhost']['upgrade_containers'] == 'y'
    - name: Reload Nginx
      command: "docker exec nginx nginx -s reload"
      when: hostvars['localhost']['upgrade_containers'] == 'y'

- name: Upgrade LAMP
  hosts: lamp
  gather_facts: no
  become: yes
  tasks:
    - import_role:
        name: dashboard
      when: hostvars['localhost']['upgrade_dashboard'] == 'y'
    - import_tasks: roles/lamp_stack/tasks/composer.yml
      when: hostvars['localhost']['upgrade_php_apps'] == 'y'
    - import_role:
        name: firefly-iii
      when: hostvars['localhost']['upgrade_php_apps'] == 'y'
