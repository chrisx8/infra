---
- name: Upgrade systems
  hosts: all
  become: true
  vars_prompt:
    - name: upgrade_homer
      prompt: "Upgrade Homer? (y/n)"
      private: no
  tasks:
  - name: Update /etc/hosts with private IP addresses
    lineinfile:
      dest: /etc/hosts
      regexp: '.*{{ item }}$'
      line: "{{ hostvars[item].private_ip }} {{ item }}"
      state: present
    when: hostvars[item].private_ip is defined and item != ansible_hostname
    with_items: "{{ groups.all }}"

  - name: Run apt dist-upgrade
    apt:
      update_cache: yes
      upgrade: dist

  - name: apt autoremove
    apt:
      autoremove: yes
      purge: yes
  - name: apt autoclean
    apt:
      autoclean: yes

  - name: Check if acme.sh exists
    stat:
      path: /root/.acme.sh/acme.sh
    register: acme_check
  - name: Upgrade acme.sh
    when: acme_check.stat.exists
    command: "/root/.acme.sh/acme.sh --upgrade"

  - name: Check if Homer exists
    stat:
      path: /var/www/html/assets
    register: homer_exist
  - name: Reinstall Homer
    when: upgrade_homer == 'y' and homer_exist.stat.exists
    import_role:
      name: app_homer

  - name: Check if BookStack exists
    stat:
      path: /var/www/bookstack
    register: bookstack_exist
  - name: Download BookStack
    when: bookstack_exist.stat.exists
    git:
      repo: https://github.com/BookStackApp/BookStack.git
      dest: /var/www/bookstack
      version: release
      depth: 1
  - name: BookStack - Composer install
    when: bookstack_exist.stat.exists
    shell:
      chdir: /var/www/bookstack
      cmd: composer install --no-dev
  - name: BookStack - Database migration
    when: bookstack_exist.stat.exists
    shell:
      chdir: /var/www/bookstack
      cmd: "php artisan migrate --force"
  - name: BookStack - Clear cache
    when: bookstack_exist.stat.exists
    shell:
      chdir: /var/www/bookstack
      cmd: "php artisan cache:clear && php artisan config:clear && php artisan view:clear"
