---
- name: Upgrade all systems
  hosts: all
  become: yes
  vars_prompt:
    - name: upgrade_homer
      prompt: "Upgrade Homer dashboard? (y/n)"
      private: no
    - name: upgrade_apps
      prompt: "Upgrade applications? (y/n)"
      private: no
  tasks:
    - name: Update /etc/hosts with private IP addresses
      import_tasks: tasks/private_ip.yml

    - name: apt dist-upgrade
      apt:
        update_cache: yes
        upgrade: dist
    - name: apt cleanup
      import_tasks: tasks/apt_post.yml

    - name: Check if acme.sh exists
      stat:
        path: ~/acme.sh
      register: acme_check
    - name: Upgrade acme.sh
      when: acme_check.stat.exists
      command: "~/acme.sh --upgrade"

    - name: Check if container stack exists
      stat:
        path: ~/containers/docker-compose.yml
      register: container_check
    - name: Upgrade/Reinstall container stack
      when: container_check.stat.exists
      import_role:
        name: containers
    - name: Reload Nginx
      when: container_check.stat.exists
      command: "docker exec nginx nginx -s reload"

    - name: Check if Homer exists
      stat:
        path: /var/www/html/assets
      register: homer_check
    - name: Upgrade/Reinstall Homer
      when: upgrade_homer == 'y' and homer_check.stat.exists
      import_role:
        name: homer

    - name: Check if Composer exists
      stat:
        path: /usr/local/bin/composer
      register: composer_check
    - name: Install Composer
      when: upgrade_apps == 'y' and composer_check.stat.exists
      import_tasks: tasks/composer.yml

    - name: Check if Firefly III exists
      stat:
        path: /var/www/firefly-iii
      register: firefly_check
    - name: Upgrade/Reinstall Firefly III
      when: upgrade_apps == 'y' and firefly_check.stat.exists
      import_role:
        name: firefly-iii
