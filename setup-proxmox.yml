---
- name: Customize Proxmox VE
  hosts: proxmox_hosts
  become: true
  vars_prompt:
    - name: ses_user
      prompt: "SES SMTP Username"
    - name: ses_pass
      prompt: "SES SMTP Password"
  tasks:
  - name: Switch to Debian HTTPS repos
    shell: "sed -i 's/http:/https:/g' /etc/apt/sources.list"
  - name: Switch to Debian repos on CDN
    shell: "sed -i 's/ftp.us.debian.org/deb.debian.org/g' /etc/apt/sources.list"

  - name: Remove Proxmox VE enterprise repo
    apt_repository:
      repo: "deb https://enterprise.proxmox.com/debian/pve {{ ansible_distribution_release }} pve-enterprise"
      state: absent

  - name: Add Proxmox VE no subscription repo
    apt_repository:
      repo: "deb http://download.proxmox.com/debian/pve {{ ansible_distribution_release }} pve-no-subscription"
      state: present
      filename: pve
  - name: Add Proxmox Backup Server no subscription repo
    apt_repository:
      repo: "deb http://download.proxmox.com/debian/pbs {{ ansible_distribution_release }} pbs-no-subscription"
      state: present
      filename: pbs

  - name: Run apt dist-upgrade
    apt:
      update_cache: yes
      upgrade: dist

  - name: Install extra Debian packages
    apt:
      name: [vim, libsasl2-modules, lm-sensors, cryptsetup-bin, ntfs-3g, udisks2]
      install_recommends: no
      state: latest
  - name: Install PVE kernel 5.11
    apt:
      name: pve-kernel-5.11
      state: latest
  - name: Install Proxmox Backup Server
    apt:
      name: proxmox-backup-server
      state: latest

  - name: apt autoremove
    apt:
      autoremove: yes
      purge: yes
  - name: apt autoclean
    apt:
      autoclean: yes

  - name: Disable udisks2 services
    systemd:
      name: udisks2.service
      state: stopped
      enabled: no
  - name: Disable PBS services (1/2)
    systemd:
      name: proxmox-backup.service
      enabled: no
  - name: Disable PBS services (2/2)
    systemd:
      name: proxmox-backup-proxy.service
      enabled: no

  - name: Configure vim
    copy:
      src: roles/sys_basic/files/vimrc
      dest: /etc/vim/vimrc
      mode: 0644

  - name: Configure OpenSSH server (1/2)
    lineinfile:
      dest: /etc/ssh/sshd_config
      regex: PermitRootLogin
      line: "PermitRootLogin prohibit-password"
  - name: Configure OpenSSH server (2/2)
    lineinfile:
      dest: /etc/ssh/sshd_config
      regex: PasswordAuthentication
      line: "PasswordAuthentication no"

  - name: Configure Postfix
    template:
      src: proxmox/etc/postfix/main.cf.j2
      dest: /etc/postfix/main.cf
  - name: Add SES credentials
    template:
      src: proxmox/etc/postfix/sasl_passwd.j2
      dest: /etc/postfix/sasl_passwd
  - name: Process credential DB
    shell: postmap /etc/postfix/sasl_passwd
  - name: Restart Postfix
    systemd:
      name: postfix.service
      state: restarted

  - name: Install scripts to /opt
    copy:
      src: proxmox/opt/
      dest: /opt
  - name: Set permission for /opt
    file:
      path: /opt
      mode: 0700
      recurse: yes

  - name: Update /etc/hosts with private IP addresses
    lineinfile:
      dest: /etc/hosts
      regexp: '.*{{ item }}$'
      line: "{{ hostvars[item].private_ip }} {{ item }}"
      state: present
    when: hostvars[item].private_ip is defined and item != ansible_hostname
    with_items: "{{ groups.all }}"

  - name: Reboot
    reboot:
