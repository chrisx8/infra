---
- name: Create a new unprivileged user
  hosts: cloud
  vars:
    username_prefix: chrx
  vars_prompt:
    - name: ssh_key
      prompt: Paste the SSH key for the new user
      private: yes
  become: true
  tasks:
  - name: Generate new username
    become: false
    command: "echo {{ username_prefix }}{{ lookup('password', '/dev/null length=4 chars=ascii_lowercase') }}"
    register: username
  - name: Create new unprivileged user
    user:
      name: "{{ username.stdout }}"
      home: "/home/{{ username.stdout }}"
      shell: /bin/bash
      groups: sudo
  - name: Enable passwordless sudo
    lineinfile:
      dest: "/etc/sudoers.d/passwordless-sudo"
      create: true
      line: "%sudo ALL=(ALL) NOPASSWD: ALL"
  - name: Install SSH key 1/2
    file:
      path: "/home/{{ username.stdout }}/.ssh"
      state: directory
      recurse: yes
      owner: "{{ username.stdout }}"
      group: "{{ username.stdout }}"
  - name: Install SSH key 2/2
    lineinfile:
      dest: "/home/{{ username.stdout }}/.ssh/authorized_keys"
      create: yes
      line: "{{ ssh_key }}"
  - name: Lock root password
    command: passwd -l root
  - name: Display new username
    debug:
      msg: "New username: {{ username.stdout }}"
