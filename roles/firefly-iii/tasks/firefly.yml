- name: Download Firefly III
  git:
    repo: https://github.com/firefly-iii/firefly-iii.git
    dest: /var/www/firefly-iii
    version: 5.6.8
    depth: 1

- name: Set permissions (1/2)
  file:
    path: /var/www/firefly-iii
    state: directory
    recurse: yes
    owner: www-data
    group: www-data
- name: Set permissions (2/2)
  file:
    path: /var/www/firefly-iii/firefly-iii/storage
    state: directory
    recurse: yes
    mode: 0775

- name: Install config file
  template:
    src: env.j2
    dest: /var/www/firefly-iii/.env
    mode: 0644
    owner: www-data
    group: www-data

- name: Composer install
  command:
    chdir: /var/www/firefly-iii
    cmd: "runuser -u www-data -- composer install --no-dev --prefer-dist"
  changed_when: yes
- name: Generate new key
  command:
    chdir: /var/www/firefly-iii  
    cmd: "php artisan key:generate --force"
  changed_when: yes
- name: Database migration
  shell:
    chdir: /var/www/firefly-iii
    cmd: "php artisan migrate --seed --force && php artisan firefly-iii:upgrade-database"
  changed_when: yes
- name: Install Passport
  command:
    chdir: /var/www/firefly-iii
    cmd: "php artisan passport:install --force"
  changed_when: yes
- name: Clear cache
  shell:
    chdir: /var/www/firefly-iii
    cmd: "php artisan cache:clear && php artisan config:clear && php artisan view:clear"
  changed_when: yes

- name: Install Firefly III cron job
  cron:
    name: "Firefly III background jobs"
    minute: "45"
    hour: "*"
    user: www-data
    job: "php -f /var/www/firefly-iii/artisan firefly-iii:cron"
