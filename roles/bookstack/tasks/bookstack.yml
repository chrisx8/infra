- name: Download BookStack
  git:
    repo: https://github.com/BookStackApp/BookStack.git
    dest: /var/www/bookstack
    version: release
    depth: 1

- name: Set permissions (1/3)
  file:
    path: /var/www/bookstack/storage
    state: directory
    recurse: true
    owner: www-data
    group: www-data
- name: Set permissions (2/3)
  file:
    path: /var/www/bookstack/bootstrap/cache
    state: directory
    recurse: true
    owner: www-data
    group: www-data
- name: Set permissions (3/3)
  file:
    path: /var/www/bookstack/public/uploads
    state: directory
    recurse: true
    owner: www-data
    group: www-data

- name: Install config file
  template:
    src: env.j2
    dest: /var/www/bookstack/.env

- name: Composer install
  shell:
    chdir: /var/www/bookstack
    cmd: "runuser -u www-data -- composer install --no-dev"
- name: Generate new key
  shell:
    chdir: /var/www/bookstack  
    cmd: "php artisan key:generate --force"
- name: Database migration
  shell:
    chdir: /var/www/bookstack
    cmd: "php artisan migrate --force"
- name: Clear cache
  shell:
    chdir: /var/www/bookstack
    cmd: "php artisan cache:clear && php artisan config:clear && php artisan view:clear"
