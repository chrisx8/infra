<VirtualHost *:80>
	ServerName tinynet.chrisx.xyz
	DocumentRoot /var/www/html

	ErrorLog ${APACHE_LOG_DIR}/error.log
	CustomLog ${APACHE_LOG_DIR}/access.log combined

	OIDCProviderMetadataURL https://tinynet-iam.chrisx.xyz/realms/master/.well-known/openid-configuration
	OIDCClientID web1auth
	OIDCClientSecret {{ oidc_client_secret }}
	OIDCRemoteUserClaim preferred_username
	OIDCScope "openid groups"
	OIDCRedirectURI https://tinynet.chrisx.xyz/auth/openid-connect
	OIDCCryptoPassphrase {{ oidc_crypto.stdout }}

	Alias "/bookstack" "/var/www/bookstack/public"

	<Location "/auth/openid-connect">
		AuthType openid-connect
		Require valid-user
	</Location>

	<Directory "/var/www/html">
		Header set Cache-Control "no-cache"
		Header set Content-Security-Policy "base-uri 'none'; object-src 'none'; script-src 'self'"
		AuthType openid-connect
		Require valid-user
	</Directory>
	
	<Directory "/var/www/html/assets/manifest.json">
		Require all granted
	</Directory>

	<Directory "/var/www/html/assets/internal.yml">
		AuthType openid-connect
		Require claim groups:internal
	</Directory>

	<Directory "/var/www/html/internal-pages">
		AuthType openid-connect
		Require claim groups:internal
	</Directory>

	<Directory "/var/www/bookstack/public">
		Options FollowSymlinks
		AllowOverride None
		Require all granted

		RewriteEngine On
		# Redirect Trailing Slashes If Not A Folder...
		RewriteCond %{REQUEST_FILENAME} !-d
		RewriteRule ^(.*)/$ /$1 [L,R=301]
		# Handle Front Controller...
		RewriteCond %{REQUEST_FILENAME} !-d
		RewriteCond %{REQUEST_FILENAME} !-f
		RewriteRule ^ index.php [L]
	</Directory>

	<Directory "/var/www/bookstack">
	  AllowOverride None
	  Require all denied
	</Directory>
</VirtualHost>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
