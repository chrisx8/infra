- name: Install WireGuard
  apt:
    name: wireguard-tools
    install_recommends: false
    state: latest
- name: apt clean
  command: "apt-get clean"

- name: Configure WireGuard
  when: wg_private_key
  template:
    src: wg0.conf.j2
    dest: /etc/wireguard/wg0.conf
    mode: 0600
- name: Check if WireGuard config exists
  stat:
    path: /etc/wireguard/wg0.conf
  register: wg_stat
- name: Start WireGuard interface
  when: wg_stat.stat.exists
  systemd:
    name: wg-quick@wg0.service
    state: restarted
    enabled: yes

- name: Enable IPv4 forwarding
  lineinfile:
    path: /etc/sysctl.conf
    regex: 'net.ipv4.ip_forward'
    line: 'net.ipv4.ip_forward = 1'
- name: Load sysctl.conf
  command: "sysctl -f /etc/sysctl.conf"
