- name: Install OpenJRE 11 (Headless)
  apt:
    name: openjdk-11-jre-headless
    state: latest

- name: Create IAM app user
  user:
    name: iamapps
    shell: /bin/false

- name: Check if Keycloak is installed
  stat:
    path: /opt/keycloak
  register: keycloak_stat
- name: Prompt for Keycloak installation
  when: not keycloak_stat.stat.exists
  pause:
    prompt: "Install keycloak to /opt/keycloak, then come back here\n
             Press Enter to continue"

- name: Configure Keycloak for use behind reverse proxy
  shell: "/opt/keycloak/bin/kc.sh config --proxy=edge"

- name: Change permission on Keycloak directory
  file:
    path: /opt/keycloak
    state: directory
    recurse: true
    owner: iamapps
    group: iamapps
    mode: 0755

- name: Set up systemd service for Keycloak
  copy:
    src: keycloak.service
    dest: /etc/systemd/system
    owner: root
    group: root
- name: Start Keycloak
  systemd:
    name: keycloak
    state: restarted
    enabled: true
    daemon-reload: true
