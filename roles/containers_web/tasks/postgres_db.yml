---
- name: Generate PostgreSQL user passwords
  ansible.builtin.set_fact:
    # yamllint disable-line rule:line-length
    postgres_passwords: "{{ postgres_passwords | combine({item.key: lookup('password', '/dev/null chars=ascii_letters,digits length=64')}) }}"
    # noqa var-naming[no-role-prefix]
  with_dict: "{{ postgres_passwords }}"
  loop_control:
    label: "{{ item.key }}"

- name: Set up PostgreSQL databases and users
  become_user: postgres
  block:
    - name: Create PostgreSQL databases
      community.postgresql.postgresql_db:
        name: "{{ item.key }}"
        state: present
      with_dict: "{{ postgres_passwords }}"
      loop_control:
        label: "{{ item.key }}"
    - name: Create PostgreSQL users
      community.postgresql.postgresql_user:
        db: "{{ item.key }}"
        name: "{{ item.key }}"
        password: "{{ item.value }}"
      with_dict: "{{ postgres_passwords }}"
      loop_control:
        label: "{{ item.key }}"
    - name: GRANT ALL PRIVILEGES ON SCHEMA public
      community.postgresql.postgresql_privs:
        db: "{{ item.key }}"
        type: schema
        objs: public
        privs: ALL
        role: "{{ item.key }}"
      with_dict: "{{ postgres_passwords }}"
      loop_control:
        label: "{{ item.key }}"
    - name: Add hstore extension to miniflux database
      community.postgresql.postgresql_ext:
        name: hstore
        db: miniflux
        state: present
