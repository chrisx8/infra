---
- name: Verify requirements
  ansible.builtin.assert:
    that:
      - cloudflared_token is defined
      - containers_web_cron_ping_url is defined
      - vaultwarden_oidc is defined
      - vaultwarden_oidc.client_id
      - vaultwarden_oidc.client_secret

- name: Allow unprivileged port bind
  ansible.posix.sysctl:
    name: net.ipv4.ip_unprivileged_port_start
    value: 80
    reload: true
    state: present

- name: Create container user
  ansible.builtin.user:
    name: "{{ container_user }}"
    create_home: true
    state: present
  register: _container_user_info

- name: Pre-launch config
  become_user: "{{ container_user }}"
  block:
    - name: Configure Apache
      ansible.builtin.import_tasks: apache.yml
    - name: Copy helper scripts
      ansible.builtin.import_tasks: scripts.yml
    - name: Set up PostgreSQL databases and users
      ansible.builtin.include_tasks: postgres_db.yml

- name: Launch containers
  ansible.builtin.import_role:
    name: containers
