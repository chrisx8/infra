- name: Load secret vars
  ansible.builtin.include_vars: secrets.yml

- name: Create containers directory
  ansible.builtin.file:
    path: ~/containers
    state: directory
    mode: 0700
  register: _containers_dir
- name: Create Nginx logs directory
  ansible.builtin.file:
    path: "{{ _containers_dir.path }}/log/nginx"
    state: directory
    mode: 0700
  register: _nginx_log_dir

- name: Copy container files
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "{{ _containers_dir.path }}"
    mode: 0644
  loop:
    - gitea
    - nginx

- name: Copy chrisx ssl certs
  ansible.builtin.include_role:
    name: sslcert
    tasks_from: chrisx.yml

- name: Set up Postgres DBs
  ansible.builtin.import_tasks: postgres_db.yml
  become_user: postgres
  delegate_to: c-lapp

- name: Create container network
  containers.podman.podman_network:
    name: ct
    state: present

- name: Launch containers
  ansible.builtin.import_role:
    name: containers

- name: Copy helper scripts
  ansible.builtin.import_tasks: scripts.yml
