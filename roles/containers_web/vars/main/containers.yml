container_user: podman

container_volumes:
  - gitea_conf
  - gitea_data
  - vaultwarden_data

container_specs:
  - name: cloudflared
    image: docker.io/cloudflare/cloudflared:latest
    command: tunnel run --token {{ cloudflared_token }}
  # Gitea: HTTP on 127.0.0.1:3000, SSH on 0.0.0.0:2222
  - name: gitea
    hostname: gitea.{{ container_defaults.hostname }}
    image: docker.io/gitea/gitea:1-rootless
    network: host
    env:
      GITEA____APP_NAME: "Gitea"
      GITEA__cache__ENABLED: "true"
      GITEA__cache_0X2E_last_commit__ENABLED: "true"
      GITEA__database__DB_TYPE: "postgres"
      GITEA__database__LOG_SQL: "false"
      GITEA__database__HOST: "postgres.arb.chrisx.xyz:5432"
      GITEA__database__NAME: "gitea"
      GITEA__database__SSL_MODE: "verify-full"
      GITEA__database__USER: "gitea"
      GITEA__database__PASSWD: "{{ postgres_gitea_password }}"
      GITEA__federation__ENABLED: "false"
      GITEA__federation__SHARE_USER_STATISTICS: "false"
      GITEA__oauth2_client__ACCOUNT_LINKING: "login"
      GITEA__oauth2_client__ENABLE_AUTO_REGISTRATION: "true"
      GITEA__other__SHOW_FOOTER_BRANDING: "true"
      GITEA__other__SHOW_FOOTER_TEMPLATE_LOAD_TIME: "false"
      GITEA__picture__DISABLE_GRAVATAR: "true"
      GITEA__picture__ENABLE_FEDERATED_AVATAR: "false"
      GITEA__security__INSTALL_LOCK: "true"
      GITEA__security__PASSWORD_HASH_ALGO: "argon2"
      GITEA__server__DOMAIN: "gitea.chrisx.xyz"
      GITEA__server__HTTP_ADDR: "127.0.0.1"
      GITEA__server__LANDING_PAGE: "login"
      GITEA__server__OFFLINE_MODE: "true"
      GITEA__server__ROOT_URL: "https://gitea.chrisx.xyz/"
      GITEA__server__SSH_PORT: "2222"
      GITEA__service__ALLOW_ONLY_EXTERNAL_REGISTRATION: "true"
      GITEA__service__DEFAULT_KEEP_EMAIL_PRIVATE: "true"
      GITEA__service__DEFAULT_USER_IS_RESTRICTED: "true"
      GITEA__service__DISABLE_REGISTRATION: "false"
      GITEA__service__ENABLE_BASIC_AUTHENTICATION: "false"
      GITEA__service__MINIMUM_KEY_SIZE_CHECK: "true"
      GITEA__service__REGISTER_MANUAL_CONFIRM: "true"
      GITEA__service__REQUIRE_SIGNIN_VIEW: "true"
      GITEA__session__COOKIE_SECURE: "true"
      GITEA__session__PROVIDER: "db"
      GITEA__ssh_0X2E_minimum_key_sizes__DSA: "-1"
      GITEA__ssh_0X2E_minimum_key_sizes__ECDSA: "-1"
      GITEA__ui__SHOW_USER_EMAIL: "false"
    volumes:
      - gitea_conf:/etc/gitea:Z
      - gitea_data:/var/lib/gitea:Z
  # Keycloak: HTTP on 127.0.0.1:8080
  - name: keycloak
    hostname: keycloak.{{ container_defaults.hostname }}
    image: quay.io/keycloak/keycloak:21.0
    command: start
    network: host
    env:
      KC_DB: "postgres"
      # yamllint disable-line rule:line-length
      KC_DB_URL: "jdbc:postgresql://postgres.arb.chrisx.xyz:5432/keycloak?ssl=true&sslmode=require&sslcert=/etc/ssl/certs/ca-bundle.crt"
      KC_DB_USERNAME: "keycloak"
      KC_DB_PASSWORD: "{{ postgres_keycloak_password }}"
      KC_HOSTNAME: "sso.chrisx.xyz"
      KC_HTTP_HOST: "127.0.0.1"
      KC_PROXY: "edge"
  # Vaultwarden: HTTP on 127.0.0.1:8288, WebSocket on 127.0.0.1:3012
  - name: vaultwarden
    hostname: vaultwarden.{{ container_defaults.hostname }}
    image: docker.io/vaultwarden/server:latest
    network: host
    cap_add:
      - NET_BIND_SERVICE
    env:
      # yamllint disable-line rule:line-length
      DATABASE_URL: "postgres://vaultwarden:{{ postgres_vaultwarden_password }}@postgres.arb.chrisx.xyz/vaultwarden?sslmode=verify-full&sslrootcert=/etc/ssl/certs/ca-certificates.crt"
      DISABLE_ADMIN_TOKEN: "true"
      DOMAIN: "https://vaultwarden.chrisx.xyz"
      EMAIL_ATTEMPTS_LIMIT: "0"
      EMAIL_EXPIRATION_TIME: "0"
      EVENTS_DAYS_RETAIN: "30"
      IP_HEADER: "X-Forwarded-For"
      ORG_EVENTS_ENABLED: "true"
      PASSWORD_HINTS_ALLOWED: "false"
      PASSWORD_ITERATIONS: "600000"
      ROCKET_ADDRESS: "127.0.0.1"
      ROCKET_PORT: "8288"
      SIGNUPS_ALLOWED: "false"
      SIGNUPS_VERIFY: "true"
      SIGNUPS_VERIFY_RESEND_LIMIT: "3"
      WEBSOCKET_ADDRESS: "127.0.0.1"
      WEBSOCKET_ENABLED: "true"
      SMTP_SECURITY: "force_tls"
      SMTP_FROM: "{{ vaultwarden_env.SMTP_FROM }}"
      SMTP_HOST: "{{ vaultwarden_env.SMTP_HOST }}"
      SMTP_PORT: "{{ vaultwarden_env.SMTP_PORT }}"
      SMTP_USERNAME: "{{ vaultwarden_env.SMTP_USERNAME }}"
      SMTP_PASSWORD: "{{ vaultwarden_env.SMTP_PASSWORD }}"
      YUBICO_CLIENT_ID: "{{ vaultwarden_env.YUBICO_CLIENT_ID }}"
      YUBICO_SECRET_KEY: "{{ vaultwarden_env.YUBICO_SECRET_KEY }}"
    volumes:
      - vaultwarden_data:/data:Z
  # Apache: HTTP on 0.0.0.0:80, HTTPS on 0.0.0.0:443
  - name: apache
    hostname: apache.{{ container_defaults.hostname }}
    image: ghcr.io/chrisx8/apache-openidc:latest
    network: host
    cap_add:
      - CHOWN
      - NET_BIND_SERVICE
      - SETGID
      - SETUID
    volumes:
      - "{{ _container_user_info.home }}/apache/conf.d:/etc/apache2/sites-enabled:ro,Z"
      - "{{ _container_user_info.home }}/apache/log:/var/log/apache2:Z"
      - "{{ _container_user_info.home }}/apache/ssl:/etc/apache2/ssl:ro,Z"
      - "{{ _container_user_info.home }}/apache/www:/var/www:ro,Z"
