---
container_user: podman

container_volumes:
  - gitea_conf
  - gitea_data
  - vaultwarden

container_specs:
  - name: cloudflared
    image: docker.io/cloudflare/cloudflared:latest
    command: tunnel run --token {{ cloudflared_token }}
    network: host
  # Gitea: HTTP on 127.0.0.1:3000, SSH on 0.0.0.0:2222
  - name: gitea
    hostname: gitea.{{ container_defaults.hostname }}
    image: docker.io/gitea/gitea:1-rootless
    network: host
    env:
      GITEA____APP_NAME: Gitea
      GITEA__cache__ENABLED: "true"
      GITEA__cache_0X2E_last_commit__ENABLED: "true"
      GITEA__database__DB_TYPE: postgres
      GITEA__database__LOG_SQL: "false"
      GITEA__database__HOST: 127.0.0.1:5432
      GITEA__database__NAME: gitea
      GITEA__database__SSL_MODE: disable
      GITEA__database__USER: gitea
      GITEA__database__PASSWD: "{{ postgres_passwords.gitea }}"
      GITEA__federation__ENABLED: "false"
      GITEA__federation__SHARE_USER_STATISTICS: "false"
      GITEA__oauth2_client__ACCOUNT_LINKING: login
      GITEA__oauth2_client__ENABLE_AUTO_REGISTRATION: "true"
      GITEA__other__SHOW_FOOTER_BRANDING: "true"
      GITEA__other__SHOW_FOOTER_TEMPLATE_LOAD_TIME: "false"
      GITEA__picture__DISABLE_GRAVATAR: "true"
      GITEA__picture__ENABLE_FEDERATED_AVATAR: "false"
      GITEA__security__INSTALL_LOCK: "true"
      GITEA__security__PASSWORD_HASH_ALGO: argon2
      GITEA__server__DOMAIN: gitea.arb.chrisx.xyz
      GITEA__server__HTTP_ADDR: 127.0.0.1
      GITEA__server__HTTP_PORT: "3000"
      GITEA__server__LANDING_PAGE: login
      GITEA__server__OFFLINE_MODE: "true"
      GITEA__server__ROOT_URL: https://gitea.arb.chrisx.xyz/
      GITEA__server__SSH_DOMAIN: gitea.arb.chrisx.xyz
      GITEA__server__SSH_PORT: "2222"
      GITEA__service__ALLOW_ONLY_EXTERNAL_REGISTRATION: "true"
      GITEA__service__DEFAULT_KEEP_EMAIL_PRIVATE: "true"
      GITEA__service__DEFAULT_USER_IS_RESTRICTED: "true"
      GITEA__service__DISABLE_REGISTRATION: "false"
      GITEA__service__ENABLE_BASIC_AUTHENTICATION: "false"
      GITEA__service__MINIMUM_KEY_SIZE_CHECK: "true"
      GITEA__service__REGISTER_MANUAL_CONFIRM: "true"
      GITEA__service__REQUIRE_SIGNIN_VIEW: "true"
      GITEA__session__COOKIE_SECURE: "true"
      GITEA__session__PROVIDER: db
      GITEA__ssh_0X2E_minimum_key_sizes__DSA: "-1"
      GITEA__ssh_0X2E_minimum_key_sizes__ECDSA: "-1"
      GITEA__ui__SHOW_USER_EMAIL: "false"
    volumes:
      - gitea_conf:/etc/gitea:Z
      - gitea_data:/var/lib/gitea:Z
  # Keycloak: HTTP on 127.0.0.1:8080
  - name: keycloak
    hostname: keycloak.{{ container_defaults.hostname }}
    image: quay.io/keycloak/keycloak:22.0
    command: start
    network: host
    env:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://127.0.0.1:5432/keycloak?ssl=false
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: "{{ postgres_passwords.keycloak }}"
      KC_HOSTNAME: sso.chrisx.xyz
      KC_HTTP_HOST: 127.0.0.1
      KC_PROXY: edge
  # Miniflux: HTTP on 127.0.0.1:8081
  - name: miniflux
    image: docker.io/miniflux/miniflux:latest
    network: host
    env:
      BASE_URL: https://miniflux.arb.chrisx.xyz
      DATABASE_URL: postgres://miniflux:{{ postgres_passwords.miniflux }}@127.0.0.1:5432/miniflux?sslmode=disable
      DISABLE_HSTS: "1"
      CLEANUP_REMOVE_SESSIONS_DAYS: "7"
      LISTEN_ADDR: 127.0.0.1:8081
      LOG_DATE_TIME: "1"
      RUN_MIGRATIONS: "1"
      OAUTH2_PROVIDER: oidc
      OAUTH2_OIDC_DISCOVERY_ENDPOINT: https://sso.chrisx.xyz/realms/chrisx
      OAUTH2_REDIRECT_URL: https://miniflux.arb.chrisx.xyz/oauth2/oidc/callback
      OAUTH2_USER_CREATION: "1"
      OAUTH2_CLIENT_ID: "{{ miniflux_oidc.client_id }}"
      OAUTH2_CLIENT_SECRET: "{{ miniflux_oidc.client_secret }}"
  # Vaultwarden: HTTP on 127.0.0.1:8288, WebSocket on 127.0.0.1:3012
  - name: vaultwarden
    hostname: vaultwarden.{{ container_defaults.hostname }}
    image: docker.io/vaultwarden/server:testing
    network: host
    env:
      _ENABLE_DUO: "false"
      _ENABLE_EMAIL_2FA: "false"
      # yamllint disable-line rule:line-length
      DATABASE_URL: postgres://vaultwarden:{{ postgres_passwords.vaultwarden }}@127.0.0.1:5432/vaultwarden?sslmode=disable
      DISABLE_ADMIN_TOKEN: "true"
      DOMAIN: https://vaultwarden.chrisx.xyz
      EVENTS_DAYS_RETAIN: "30"
      IP_HEADER: X-Forwarded-For
      ORG_EVENTS_ENABLED: "true"
      PASSWORD_HINTS_ALLOWED: "false"
      PASSWORD_ITERATIONS: "600000"
      PUSH_ENABLED: "true"
      PUSH_INSTALLATION_ID: "{{ vaultwarden_env.PUSH_INSTALLATION_ID }}"
      PUSH_INSTALLATION_KEY: "{{ vaultwarden_env.PUSH_INSTALLATION_KEY }}"
      ROCKET_ADDRESS: 127.0.0.1
      ROCKET_PORT: "8288"
      SIGNUPS_ALLOWED: "false"
      SIGNUPS_VERIFY: "true"
      SIGNUPS_VERIFY_RESEND_LIMIT: "3"
      SMTP_FROM: "{{ vaultwarden_env.SMTP_FROM }}"
      SMTP_HOST: "{{ vaultwarden_env.SMTP_HOST }}"
      SMTP_PORT: "{{ vaultwarden_env.SMTP_PORT }}"
      SMTP_USERNAME: "{{ vaultwarden_env.SMTP_USERNAME }}"
      SMTP_PASSWORD: "{{ vaultwarden_env.SMTP_PASSWORD }}"
      SMTP_SECURITY: force_tls
      WEBSOCKET_ADDRESS: 127.0.0.1
      WEBSOCKET_ENABLED: "true"
      YUBICO_CLIENT_ID: "{{ vaultwarden_env.YUBICO_CLIENT_ID }}"
      YUBICO_SECRET_KEY: "{{ vaultwarden_env.YUBICO_SECRET_KEY }}"
    volumes:
      - vaultwarden:/data:Z
  # Apache: HTTP on 0.0.0.0:80, HTTPS on 0.0.0.0:443
  - name: apache
    hostname: apache.{{ container_defaults.hostname }}
    image: ghcr.io/chrisx8/apache-openidc:latest
    network: host
    cap_add:
      - CHOWN
      - NET_BIND_SERVICE
      - SETGID
      - SETUID
    volumes:
      - "{{ _container_user_info.home }}/apache/conf.d:/etc/apache2/sites-enabled:ro,Z"
      - "{{ _container_user_info.home }}/apache/log:/var/log/apache2:Z"
      - "{{ _container_user_info.home }}/apache/ssl:/etc/apache2/ssl:ro,Z"
      - "{{ _container_user_info.home }}/apache/www:/var/www:ro,Z"
