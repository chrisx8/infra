---
- name: Create Jellyfin dirs
  ansible.builtin.file:
    path: "{{ item }}"
    mode: "0755"
    state: directory
  loop:
    - "{{ _container_user.home }}/jellyfin/cache"
    - "{{ _container_user.home }}/jellyfin/config/plugins/keycloak-auth"

- name: Download jellyfin-plugin-keycloak-auth
  ansible.builtin.get_url:
    url: "{{ item }}"
    dest: "{{ _container_user.home }}/jellyfin/config/plugins/keycloak-auth"
    mode: "0644"
  loop:
    - https://github.com/Ugrend/jellyfin-plugin-keycloak-auth/releases/latest/download/Jellyfin.Plugin.Keycloak.dll
    - https://github.com/Ugrend/jellyfin-plugin-keycloak-auth/releases/latest/download/JWT.dll

- name: Copy backup script
  ansible.builtin.template:
    src: jellyfin/backup.sh.j2
    dest: "{{ _container_user.home }}/jellyfin/backup.sh"
    mode: "0750"

- name: Disable cron mail
  ansible.builtin.cron:
    name: MAILTO
    env: true
    job: ""
- name: Set up backup cron job
  ansible.builtin.cron:
    name: jellyfin backup
    job: "{{ _container_user.home }}/jellyfin/backup.sh"
    hour: 22
    minute: 12
    state: present
