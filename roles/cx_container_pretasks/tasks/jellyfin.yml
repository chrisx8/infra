---
- name: Create Jellyfin dirs
  ansible.builtin.file:
    path: "{{ item }}"
    mode: "0755"
    state: directory
  loop:
    - "{{ _container_user.home }}/jellyfin/cache"
    - "{{ _container_user.home }}/jellyfin/config/plugins/keycloak-auth"

- name: Download jellyfin-plugin-keycloak-auth
  ansible.builtin.get_url:
    url: "{{ item }}"
    dest: "{{ _container_user.home }}/jellyfin/config/plugins/keycloak-auth"
    mode: "0644"
  loop:
    - https://github.com/Ugrend/jellyfin-plugin-keycloak-auth/releases/latest/download/Jellyfin.Plugin.Keycloak.dll
    - https://github.com/Ugrend/jellyfin-plugin-keycloak-auth/releases/latest/download/JWT.dll

- name: Copy backup script
  ansible.builtin.template:
    src: jellyfin/backup.sh.j2
    dest: "{{ _container_user.home }}/jellyfin/backup.sh"
    mode: "0750"

- name: Disable cron mail
  ansible.builtin.cron:
    name: MAILTO
    env: true
    job: ""
- name: Set up backup cron job
  ansible.builtin.cron:
    name: jellyfin backup
    job: "{{ _container_user.home }}/jellyfin/backup.sh"
    hour: 22
    minute: 12
    state: present

- name: Generate PKCS12 bundle on localhost
  become: false
  check_mode: false
  delegate_to: localhost
  block:
    - name: Create temp dir
      changed_when: false
      register: _temp_dir
      ansible.builtin.tempfile:
        state: directory
    - name: Generate PKCS12 bundle
      changed_when: false
      ansible.builtin.command:
        cmd: >-
          openssl pkcs12 -export -passout pass:
          -out {{ _temp_dir.path }}/{{ ssl_domain }}.p12
          -inkey files/certbot.d/config/live/{{ ssl_domain }}/privkey.pem
          -in files/certbot.d/config/live/{{ ssl_domain }}/fullchain.pem

- name: Copy PKCS12 bundle
  ansible.builtin.copy:
    src: "{{ _temp_dir.path }}/{{ ssl_domain }}.p12"
    dest: "{{ _container_user.home }}/jellyfin/cache/{{ ssl_domain }}.p12"
    mode: "0400"

- name: Delete temp dir
  become: false
  check_mode: false
  changed_when: false
  delegate_to: localhost
  ansible.builtin.file:
    path: "{{ _temp_dir.path }}"
    state: absent
