- name: Download acme.sh install script
  get_url:
    url: "https://get.acme.sh"
    dest: /tmp/acme.sh
    mode: 0755
- name: Install acme.sh
  command: "/tmp/acme.sh email={{ acme_email }}"
  changed_when: yes
- name: Delete acme.sh install script
  file:
    path: /tmp/acme.sh
    state: absent
- name: Issue certificate with acme.sh
  changed_when: yes
  shell: "export CF_Token='{{ cf_token }}' && \\
          export CF_Account_ID='{{ cf_account_id }}' && \\
          export CF_Zone_ID='{{ cf_zone_id }}' && \\
          ~/.acme.sh/acme.sh --set-default-ca --server letsencrypt && \
          ~/.acme.sh/acme.sh --issue --dns dns_cf -d {{ acme_domain }} -d *.{{ acme_domain }} && \\
          ~/.acme.sh/acme.sh --install-cert -d {{ acme_domain }} \\
            --reloadcmd 'docker restart nginx'"
