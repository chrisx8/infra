- name: Create containers directory
  file:
    path: ~/containers
    state: directory
    mode: 0700
- name: Create Nginx logs directory
  file:
    path: ~/log/nginx
    state: directory
    mode: 0700

- name: Configure UDP receive buffer size
  sysctl:
    name: net.core.rmem_max
    value: 2500000
    state: present
    sysctl_set: yes
    reload: yes

- name: Get latest cloudflared version number from GitHub
  uri:
    url: https://api.github.com/repos/cloudflare/cloudflared/releases/latest
    method: GET
  register: cloudflared_info
- name: Install docker-compose.yml
  template:
    src: docker-compose.yml
    dest: ~/containers/docker-compose.yml
    mode: 0644

- name: Install Nginx files
  copy:
    src: nginx
    dest: ~/containers
    mode: 0644

- name: Pull container images (docker-compose)
  command:
    chdir: ~/containers
    cmd: "docker-compose pull"
  changed_when: yes
- name: Start containers (docker-compose)
  command:
    chdir: ~/containers
    cmd: "docker-compose up -d --build --remove-orphans"
  changed_when: yes
- name: Clean up container storage
  command: "docker system prune -af"
  changed_when: yes

- name: Change owner of vaultwarden data volume
  file:
    path: /var/lib/docker/volumes/containers_vaultwarden_data/_data
    state: directory
    recurse: yes
    owner: nobody
    group: nogroup
