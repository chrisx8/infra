- name: Create containers directory
  file:
    path: ~/containers
    state: directory
    mode: 0700
- name: Create Nginx logs directory
  file:
    path: ~/log/nginx
    state: directory
    mode: 0700

- name: Load version info vars
  include_vars: versions.yml
- name: Get latest cloudflared version number from GitHub
  uri:
    url: https://api.github.com/repos/cloudflare/cloudflared/releases/latest
    method: GET
  register: cloudflared_info
- name: Install docker-compose.yml
  template:
    src: docker-compose.yml
    dest: ~/containers/docker-compose.yml
    mode: 0644

- name: Install Nginx files
  copy:
    src: nginx
    dest: ~/containers
    mode: 0644

- name: Create changedetection.io directory
  file:
    path: ~/containers/changedetectionio/templates
    mode: 0755
    state: directory
- name: Download changedetetion.io base.html template
  get_url:
    url: https://github.com/dgtlmoon/changedetection.io/raw/master/changedetectionio/templates/base.html
    dest: ~/containers/changedetectionio/templates/
    mode: 0644
    owner: nobody
    group: nogroup
- name: Apply changedetetion.io base.html patch
  patch:
    src: changedetectionio/base.html.patch
    dest: ~/containers/changedetectionio/templates/base.html

- name: Pull container images (docker-compose)
  command:
    chdir: ~/containers
    cmd: "docker compose pull"
  changed_when: yes
- name: Start containers (docker-compose)
  command:
    chdir: ~/containers
    cmd: "docker compose up -d --build --remove-orphans"
  changed_when: yes
- name: Clean up container storage
  command: "docker system prune -af"
  changed_when: yes

- name: Change owner of changedetetion.io data volume
  file:
    path: /var/lib/docker/volumes/containers_changedetection_data/_data
    state: directory
    recurse: yes
    owner: nobody
    group: nogroup

- name: Change owner of vaultwarden data volume
  file:
    path: /var/lib/docker/volumes/containers_vaultwarden_data/_data
    state: directory
    recurse: yes
    owner: nobody
    group: nogroup
