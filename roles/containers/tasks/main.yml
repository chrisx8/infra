---
- name: Verify requirements
  ansible.builtin.assert:
    that:
      - ansible_facts.distribution_major_version|int >= 8
      - ansible_facts.os_family == 'RedHat'
      - ansible_facts.virtualization_type == 'kvm'
      - container_specs
      - container_user != 'root'

- name: Install Podman
  ansible.builtin.dnf:
    name: podman
    state: present

- name: Create container user
  ansible.builtin.user:
    name: "{{ container_user }}"
    create_home: true
    password_lock: true
    state: present
  register: _container_user_info

- name: Enable linger for container user
  ansible.builtin.command: loginctl enable-linger {{ container_user }}
  changed_when: false

- name: Run as container user
  become: true
  become_user: "{{ container_user }}"
  block:
    - name: Set up container user
      ansible.builtin.import_tasks: user.yml
    - name: Set up containers
      ansible.builtin.import_tasks: containers.yml
