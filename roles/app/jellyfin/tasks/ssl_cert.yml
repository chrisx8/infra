- name: Generate pfx on localhost
  delegate_to: localhost
  become: false
  block:
    - name: Create temp dir
      ansible.builtin.tempfile:
        state: directory
      register: _temp_dir
      changed_when: false
    - name: Copy cert to temp dir
      ansible.builtin.copy:
        src: certbot/config/live/arb.chrisx.xyz/fullchain.pem
        dest: "{{ _temp_dir.path }}"
        mode: 0600
      changed_when: false
    - name: Copy key to temp dir
      ansible.builtin.copy:
        src: certbot/config/live/arb.chrisx.xyz/privkey.pem
        dest: "{{ _temp_dir.path }}"
        mode: 0600
      changed_when: false
    - name: Generate pfx on localhost
      ansible.builtin.command:
        chdir: "{{ _temp_dir.path }}"
        cmd: "openssl pkcs12 -export -out arb.pfx -inkey privkey.pem -in fullchain.pem"
      changed_when: false

- name: Install pfx for Jellyfin
  ansible.builtin.copy:
    src: "{{ _temp_dir.path }}/arb.pfx"
    dest: /etc/jellyfin/arb.pfx
    mode: 0400
    owner: jellyfin
    group: jellyfin
  notify:
    - Restart Jellyfin
- name: Delete temp dir
  delegate_to: localhost
  become: false
  ansible.builtin.file:
    path: "{{ _temp_dir.path }}"
    state: absent
  changed_when: false
