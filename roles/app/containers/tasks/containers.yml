- name: Create container network
  containers.podman.podman_network:
    name: "{{ container_defaults.network }}"
    state: present

- name: Create gitea_data volume
  containers.podman.podman_volume:
    name: gitea_data
    state: present
- name: Create vaultwarden_data volume
  containers.podman.podman_volume:
    name: vaultwarden_data
    state: present

- name: Pull container images
  containers.podman.podman_image:
    name: "{{ item.image }}"
    force: true
    pull: true
    state: present
  loop: "{{ container_specs }}"
- name: Create containers
  containers.podman.podman_container: "{{ item }}"
  loop: "{{ container_specs }}"
- name: Enable and start container systemd services
  ansible.builtin.systemd:
    name: "{{ container_defaults.generate_systemd.container_prefix }}-{{ item.name }}"
    enabled: true
    daemon_reload: true
    state: restarted
  loop: "{{ container_specs }}"

- name: Clean up container storage
  ansible.builtin.command: "podman system prune -af"
  changed_when: false
