- name: Create containers directory
  ansible.builtin.file:
    path: ~/containers
    state: directory
    mode: 0700
  register: containers_dir
- name: Create Nginx logs directory
  ansible.builtin.file:
    path: "{{ containers_dir.path }}/log/nginx"
    state: directory
    mode: 0700
  register: nginx_log_dir

- name: Copy logrotate config
  ansible.builtin.template:
    src: logrotate.conf.j2
    dest: "{{ containers_dir.path }}/log/logrotate.conf"
    mode: 0644

- name: Set up logrotate cron job
  ansible.builtin.cron:
    name: container logrotate
    # yamllint disable-line rule:line-length
    job: "/usr/sbin/logrotate -s {{ containers_dir.path }}/log/logrotate.state {{ containers_dir.path }}/log/logrotate.conf"
    hour: 2
    minute: 0
    state: present

- name: Create container volumes
  containers.podman.podman_volume:
    name: "{{ item }}"
    state: present
  loop: "{{ container_volumes }}"

- name: Change owner of vaultwarden data volume
  ansible.builtin.file:
    path: /var/lib/containers/storage/volumes/vaultwarden_data/_data
    state: directory
    recurse: true
    owner: nobody
    group: nobody

- name: Copy env files
  ansible.builtin.template:
    src: "{{ item.name }}.env.j2"
    dest: "{{ item.env_file }}"
    mode: 0640
  loop: "{{ container_specs }}"
  when: item.env_file is defined
- name: Copy container files
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: ~/containers
    mode: 0644
  loop:
    - gitea
    - nginx
