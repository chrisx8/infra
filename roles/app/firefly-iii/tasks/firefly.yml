- name: Get latest Firefly III version number from GitHub
  uri:
    url: https://api.github.com/repos/firefly-iii/firefly-iii/releases/latest
    method: GET
  register: firefly_info
- name: Download Firefly III
  git:
    repo: https://github.com/firefly-iii/firefly-iii.git
    dest: /var/www/firefly-iii
    version: "{{ firefly_info['json']['tag_name'] }}"
    depth: 1

- name: Set permissions (1/2)
  file:
    path: /var/www/firefly-iii
    state: directory
    recurse: true
    owner: www-data
    group: www-data
- name: Set permissions (2/2)
  file:
    path: /var/www/firefly-iii/firefly-iii/storage
    state: directory
    recurse: true
    mode: 0775

- name: Install config file
  template:
    src: env.j2
    dest: /var/www/firefly-iii/.env
    mode: 0644
    owner: www-data
    group: www-data

- name: Composer install
  become_user: www-data
  command:
    chdir: /var/www/firefly-iii
    cmd: "composer install --no-dev --prefer-dist"
  changed_when: true
- name: Generate new key
  command:
    chdir: /var/www/firefly-iii  
    cmd: "php artisan key:generate --force"
  changed_when: true
- name: Database migration
  shell:
    chdir: /var/www/firefly-iii
    cmd: "php artisan migrate --seed --force && php artisan firefly-iii:upgrade-database"
  changed_when: true
- name: Install Passport
  command:
    chdir: /var/www/firefly-iii
    cmd: "php artisan passport:install --force"
  changed_when: true
- name: Clear cache
  shell:
    chdir: /var/www/firefly-iii
    cmd: "php artisan cache:clear && php artisan config:clear && php artisan view:clear"
  changed_when: true

- name: Install Firefly III cron job
  cron:
    name: "Firefly III background jobs"
    minute: "45"
    hour: "*"
    user: www-data
    job: "php -f /var/www/firefly-iii/artisan firefly-iii:cron"
