- name: Install WireGuard
  apt:
    name: wireguard-tools
    install_recommends: false
    state: latest
- name: Configure WireGuard
  when: wg_private_key
  template:
    src: wg0.conf.j2
    dest: /etc/wireguard/wg0.conf
    mode: 0600
- name: Check if WireGuard config exists
  stat:
    path: /etc/wireguard/wg0.conf
  register: wg_stat
- name: Start WireGuard interface
  when: wg_stat.stat.exists
  systemd:
    name: wg-quick@wg0.service
    state: restarted
    enabled: yes

- name: Enable IPv4 forwarding
  shell: "echo 'net.ipv4.ip_forward = 1' > /etc/sysctl.conf"
- name: Load sysctl
  command: "sysctl -f /etc/sysctl.conf"

- name: Install acme.sh
  when: acme_email
  shell: "curl https://get.acme.sh | sh -s email={{ acme_email }}"
- name: Install acme.sh post-renew script
  copy:
    src: distribute_cert.sh
    dest: /opt/distribute_cert.sh
    mode: 0700

- name: Issue certificate with acme.sh
  when: acme_email
  pause:
    prompt: "Issue a certificate with acme.sh, then come back here\n
             =====================================================\n
              export CF_Token='x' \n
              export CF_Account_ID='x' \n
              export CF_Zone_ID='x' \n
              acme.sh --issue --dns dns_cf -d <domain> -d *.<domain> \\ \n
                --renew-hook 'bash /opt/distribute_cert.sh' \n
              acme.sh --install-cert -d <domain> \\ \n
                --fullchain-file /etc/ssl/private/fullchain.pem \\ \n
                --key-file /etc/ssl/private/privkey.pem \\ \n
                --reloadcmd 'systemctl reload nginx.service' \n
             =====================================================\n
             Press Enter to continue"

- name: Install favicon
  copy:
    src: dashboard/favicon.ico
    dest: /var/www/favicon.ico
- name: Install 404 page
  copy:
    src: nginx/ingress/iam-404.html
    dest: /var/www/iam-404.html
- name: Install Nginx configurations
  copy:
    src: nginx/ingress/conf.d
    dest: /etc/nginx/
    directory_mode: true
- name: Restart Nginx
  systemd:
    name: nginx
    state: restarted

- name: Check if deploy key exists
  stat:
    path: "/root/.ssh/id_ed25519"
  register: deploy_key_exists
- name: Generate cert deploy key
  when: not deploy_key_exists.stat.exists
  command: "ssh-keygen -t ed25519 -N '' -f ~/.ssh/id_ed25519"
- name: Retrieve public deploy key
  command: "cat ~/.ssh/id_ed25519.pub"
  register: deploy_key
- name: Display public deploy key
  debug:
    msg: "Add this key to all servers: '{{ deploy_key.stdout }}'"
