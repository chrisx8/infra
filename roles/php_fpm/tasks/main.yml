- name: Verify system
  ansible.builtin.assert:
    that:
      - ansible_facts.distribution != 'Fedora'
      - ansible_facts.distribution_major_version == '9'
      - ansible_facts.os_family == 'RedHat'

- name: Install PHP 8.1 from AppStream
  ansible.builtin.dnf:
    name: "@php:8.1"
    state: present
  when: php_use_remi is undefined or not php_use_remi

- name: Install PHP 8.1 from Remi Modular repo
  when: php_use_remi is defined and php_use_remi
  block:
    - name: Enable CRB repo
      ansible.builtin.command:
        cmd: "dnf config-manager --set-enabled crb"
      changed_when: true
    - name: Install Remi repo
      ansible.builtin.dnf:
        name: https://rpms.remirepo.net/enterprise/remi-release-9.rpm
        state: present
    - name: Install PHP 8.1 from Remi
      ansible.builtin.dnf:
        name: "@php:remi-8.1"
        state: present

- name: Install PHP components
  ansible.builtin.dnf:
    name:
      - php-cli
      - php-fpm
      - php-opcache
    state: present

- name: Install Composer
  ansible.builtin.dnf:
    name: composer
    state: present
  when: php_install_composer is defined and php_install_composer

- name: Configure PHP
  ansible.builtin.blockinfile:
    path: /etc/php.ini
    state: present
    block: |
      expose_php = Off
      post_max_size = 20M
      upload_max_filesize = 20M

- name: Enable and restart php-fpm
  ansible.builtin.systemd:
    name: php-fpm
    enabled: true
    state: restarted
