- name: Install PHP extensions
  apt:
    name: [php-bcmath, php-curl, php-gd, php-gmp, php-imagick, php-intl, php-mbstring, php-xml, php-zip]
    state: latest

- name: Install Apache site configuration
  copy:
    src: nextcloud.conf
    dest: /etc/apache2/sites-available/nextcloud.conf
- name: Enable Apache site
  shell: "a2ensite nextcloud.conf"
- name: Reload Apache
  systemd:
    name: apache2
    state: reloaded

- name: Check if Nextcloud is installed
  stat:
    path: /var/www/nextcloud/index.php
  register: nextcloud_stat

- name: Generate new password for MySQL nextcloud user
  command: "echo {{ lookup('password', '/dev/null length=64') }}"
  register: mysql_nextcloud_password
- name: Create database
  mysql_db:
    name: nextcloud
    state: present
- name: Create MySQL nextcloud user
  mysql_user:
    name: nextcloud
    host: localhost
    password: "{{ mysql_nextcloud_password.stdout }}"
    priv:
      'nextcloud.*': 'ALL'
    state: present

- name: Configure PHP-FPM (1/2)
  when: not nextcloud_stat.stat.exists
  lineinfile:
    path: /etc/php/7.4/fpm/pool.d/www.conf
    line: "env[HOSTNAME] = $HOSTNAME\n
          env[PATH] = /usr/local/bin:/usr/bin:/bin\n
          env[TMP] = /tmp\n
          env[TMPDIR] = /tmp\n
          env[TEMP] = /tmp\n
          "
- name: Configure PHP-FPM (2/2)
  lineinfile:
    path: /etc/php/7.4/fpm/php.ini
    regexp: '^memory_limit'
    line: 'memory_limit = 512M'
- name: Restart PHP
  systemd:
    name: php7.4-fpm
    state: restarted

- name: Create Nextcloud directory
  file:
    path: /var/www/nextcloud
    state: directory
    owner: www-data
    group: www-data
    mode: 0755
- name: Download Nextcloud installer
  when: not nextcloud_stat.stat.exists
  command: "curl -o /var/www/nextcloud/index.php https://download.nextcloud.com/server/installer/setup-nextcloud.php"
- name: Prompt for Nextcloud setup
  when: not nextcloud_stat.stat.exists
  pause:
    prompt: "Finish Nextcloud installation at /nextcloud/index.php \n
    Storage path: /data/nextcloud \n
    Database: MySQL server on localhost \n
    DB Name: nextcloud \n
    DB Username: nextcloud \n
    DB Password: {{ mysql_nextcloud_password.stdout }} \n\n
  "

- name: Configure crontab for www-data
  cron:
    env: true
    name: MAILTO
    user: www-data
    job: ""
- name: Install Nextcloud cron job
  cron:
    name: "Nextcloud background jobs"
    minute: "*/5"
    user: www-data
    job: "php -f /var/www/nextcloud/cron.php"

- name: Update database credential
  lineinfile:
    path: /var/www/nextcloud/config/config.php
    regexp: 'dbpassword'
    line: "'dbpassword' => '{{ mysql_nextcloud_password.stdout }}',"

- name: Inject extra Nextcloud config options
  when: not nextcloud_stat.stat.exists
  lineinfile:
    path: /var/www/nextcloud/config/config.php
    regexp: 'installed'
    line: "'installed' => 'true',\n
    'overwrite.cli.url' => 'https://tinynet.chrisx.xyz/nextcloud',\n
    'htaccess.RewriteBase' => '/nextcloud',\n
    'trusted_proxies' => ['172.17.0.10'],\n
    'auth.webauthn.enabled' => false,\n
    'default_phone_region' => 'US',
    "
- name: Update htaccess
  shell: "runuser -u www-data php /var/www/nextcloud/occ maintenance:update:htaccess"
