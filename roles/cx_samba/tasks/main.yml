---
- name: Verify system requirements
  ansible.builtin.assert:
    that:
      - ansible_facts.os_family == 'RedHat'
      - ansible_facts.distribution_major_version|int >= 8

- name: Validate cx_samba_shares
  ansible.builtin.assert:
    that:
      - item.name
      - item.comment
      - item.path and item.path.startswith('/')
      - item.browsable in ('yes', 'no')
      - item.create_mask|length == 4
      - item.directory_mask|length == 4
  loop: "{{ cx_samba_shares }}"

- name: Install packages
  ansible.builtin.dnf:
    name:
      - rclone
      - rsync
      - samba
      - tree
    state: present

- name: Copy Samba config
  ansible.builtin.template:
    src: smb.conf.j2
    dest: /etc/samba/smb.conf
    mode: "0640"

- name: Configure SELinux
  ansible.posix.seboolean:
    name: "{{ item }}"
    state: true
  loop:
    - samba_enable_home_dirs
    - samba_export_all_rw

- name: Enable and restart Samba services
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
    state: restarted
  loop:
    - nmb
    - smb
