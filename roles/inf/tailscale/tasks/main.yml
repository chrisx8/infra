- name: Disable systemd-resolved
  systemd:
    name: systemd-resolved.service
    enabled: false
    state: stopped

- name: Add Tailscale repo keys
  get_url:
    url: https://pkgs.tailscale.com/stable/ubuntu/{{ ansible_distribution_release|lower }}.noarmor.gpg
    dest: /etc/apt/trusted.gpg.d/tailscale.gpg
    mode: 0644
- name: Add Tailscale repo
  apt_repository:
    repo: deb https://pkgs.tailscale.com/stable/{{ ansible_distribution|lower }} {{ ansible_distribution_release|lower }} main
    state: present
- name: Install Tailscale
  apt:
    name: tailscale
    state: present
    update_cache: true
- import_tasks: apt_post.yml

- name: Change sysctl configs
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    sysctl_set: true
    reload: true
  with_dict: "{{ sysctl_config }}"

- name: Prompt for Tailscale setup
  pause:
    prompt: "
      Finish Tailscale setup in a terminal session: \n\n
      tailscale up --accept-dns=false --advertise-routes=x.x.x.x/x \n\n"
