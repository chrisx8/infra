- name: Disable systemd-resolved
  ansible.builtin.systemd:
    name: systemd-resolved.service
    enabled: false
    state: stopped

- name: Add Tailscale repo keys
  ansible.builtin.get_url:
    url: "https://pkgs.tailscale.com/stable/ubuntu/{{ ansible_distribution_release|lower }}.noarmor.gpg"
    dest: /etc/apt/trusted.gpg.d/tailscale.gpg
    mode: 0644
- name: Add Tailscale repo
  ansible.builtin.apt_repository:
    repo: "deb https://pkgs.tailscale.com/stable/{{ ansible_distribution|lower }} {{ ansible_distribution_release|lower }} main"
    state: present
- name: Install Tailscale
  ansible.builtin.apt:
    name: tailscale
    state: present
    update_cache: true
- name: Post-run apt cleanup
  ansible.builtin.import_role:
    name: sys/base
    tasks_from: apt_post.yml

- name: Change sysctl configs
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    sysctl_set: true
    reload: true
  with_dict: "{{ sysctl_config }}"

- name: Prompt for Tailscale setup
  ansible.builtin.pause:
    prompt: "
      Finish Tailscale setup in a terminal session: \n\n
      tailscale up --accept-dns=false --advertise-routes=x.x.x.x/x \n\n"
