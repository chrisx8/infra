- name: Verify system
  ansible.builtin.assert:
    that:
      - ansible_facts.os_family == 'Debian' or ansible_facts.os_family == 'RedHat'
      - ansible_facts.virtualization_type != 'lxc'

- name: Add Tailscale repo (apt)
  ansible.builtin.lineinfile:
    path: /etc/apt/sources.list.d/tailscale.list
    regexp: "^deb https://pkg.tailscale.com/stable/"
    line: "deb https://pkgs.tailscale.com/stable/{{ ansible_facts.distribution|lower }} {{ ansible_facts.distribution_release|lower }} main"  # yamllint disable-line rule:line-length
    create: true
    mode: 0644
    state: present
  when: ansible_facts.os_family == 'Debian'
- name: Add Tailscale repo key (apt)
  ansible.builtin.get_url:
    url: "https://pkgs.tailscale.com/stable/{{ ansible_facts.distribution|lower }}/{{ ansible_facts.distribution_release|lower }}.noarmor.gpg"  # yamllint disable-line rule:line-length
    dest: /etc/apt/trusted.gpg.d/tailscale-archive-keyring.gpg
    mode: 0644

- name: Add Tailscale repo (yum)
  ansible.builtin.yum_repository:
    name: tailscale
    description: Tailscale stable
    baseurl: https://pkgs.tailscale.com/stable/rhel/{{ ansible_facts.distribution_major_version }}/$basearch
    gpgkey: https://pkgs.tailscale.com/stable/rhel/{{ ansible_facts.distribution_major_version }}/repo.gpg
    async: false
    gpgcheck: false
    repo_gpgcheck: true
    state: present
  when: ansible_facts.os_family == 'RedHat'

- name: Install Tailscale (apt)
  ansible.builtin.apt:
    name: tailscale
    update_cache: true
    state: present
  when: ansible_facts.os_family == 'Debian'
- name: Install Tailscale (dnf)
  ansible.builtin.dnf:
    name: tailscale
    update_cache: true
    state: present
  when: ansible_facts.os_family == 'RedHat'

- name: Enable and start tailscaled
  ansible.builtin.systemd:
    name: tailscaled.service
    enabled: true
    state: started

- name: Change sysctl configs
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    sysctl_set: true
    reload: true
  with_dict:
    net.ipv4.ip_forward: 1
    net.ipv6.conf.all.forwarding: 1

- name: Prompt for Tailscale setup
  ansible.builtin.pause:
    prompt: "
      Finish Tailscale setup in a terminal session: \n\n
      tailscale up --accept-dns=false --advertise-routes=x.x.x.x/x \n\n"
