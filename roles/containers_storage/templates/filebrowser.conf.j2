<VirtualHost *:443>
	ServerName storage.arb.chrisx.xyz

	Protocols h2 http/1.1
	SSLEngine on
	SSLCertificateFile /etc/ssl/arb.chrisx.xyz/fullchain.pem
	SSLCertificateKeyFile /etc/ssl/arb.chrisx.xyz/privkey.pem

	Header set Referrer-Policy "no-referrer"
	Header set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
	Header set X-Content-Type-Options "nosniff"
	Header set X-Frame-Options "DENY"
	Header set X-Robots-Tag "none"

	RequestHeader set X-Forwarded-Proto "https"
	RequestHeader set X-Forwarded-Port "443"

	ProxyPreserveHost On
	ProxyPass "/" "http://127.0.0.1:58001/"
	ProxyPassReverse "/" "http://127.0.0.1:58001/"

	ErrorLog /var/log/httpd/filebrowser_error_log
	CustomLog /var/log/httpd/filebrowser_access_log combined

	OIDCClientID storage.arb.chrisx.xyz
	OIDCClientSecret {{ storage_client_secret }}
	OIDCPassClaimsAs headers
	OIDCProviderMetadataURL https://sso.chrisx.xyz/realms/chrisx/.well-known/openid-configuration
	OIDCRedirectURI https://storage.arb.chrisx.xyz/auth/openid-connect
	OIDCScope "openid profile"
	OIDCSessionInactivityTimeout 3600
	OIDCStateMaxNumberOfCookies 2 true
	OIDCCryptoPassphrase {{ oidc_crypto }}

	<Location "/auth/openid-connect">
		AuthType openid-connect
		Require valid-user
	</Location>

	<Location "/">
		AuthType openid-connect
		Require claim roles:filebrowser
	</Location>
	<Location "/api/public/">
		Require all granted
	</Location>
	<LocationMatch "^/(share|static)/">
		Require all granted
	</LocationMatch>
</VirtualHost>
