- name: Load secret vars
  ansible.builtin.include_vars: secrets.yml

- name: Verify requirements
  ansible.builtin.assert:
    that:
      - ansible_facts.distribution != 'Fedora'
      - ansible_facts.os_family == 'Debian' or ansible_facts.os_family == 'RedHat'
      - ansible_facts.virtualization_type != 'lxc'
      - tailscale_advertise_routes is defined

- name: Install Tailscale (Debian)
  when: ansible_facts.os_family == 'Debian'
  block:
    - name: Add Tailscale repo list (apt)
      ansible.builtin.lineinfile:
        path: /etc/apt/sources.list.d/tailscale.list
        regexp: "^deb https://pkg.tailscale.com/stable/"
        # yamllint disable-line rule:line-length
        line: "deb https://pkgs.tailscale.com/stable/{{ ansible_facts.distribution | lower }} {{ ansible_facts.distribution_release | lower }} main"
        create: true
        mode: 0644
        state: present
    - name: Add Tailscale repo key (apt)
      ansible.builtin.get_url:
        # yamllint disable-line rule:line-length
        url: "https://pkgs.tailscale.com/stable/{{ ansible_facts.distribution | lower }}/{{ ansible_facts.distribution_release | lower }}.noarmor.gpg"
        dest: /etc/apt/trusted.gpg.d/tailscale-archive-keyring.gpg
        mode: 0644
    - name: Install Tailscale (apt)
      ansible.builtin.apt:
        name: tailscale
        update_cache: true
        state: present

- name: Install Tailscale (RedHat)
  when: ansible_facts.os_family == 'RedHat'
  block:
    - name: Add Tailscale repo (dnf)
      ansible.builtin.yum_repository:
        name: tailscale
        description: Tailscale stable
        baseurl: https://pkgs.tailscale.com/stable/rhel/{{ ansible_facts.distribution_major_version }}/$basearch
        gpgkey: https://pkgs.tailscale.com/stable/rhel/{{ ansible_facts.distribution_major_version }}/repo.gpg
        async: false
        gpgcheck: false
        repo_gpgcheck: true
        state: present
    - name: Install Tailscale (dnf)
      ansible.builtin.dnf:
        name: tailscale
        update_cache: true
        state: present

- name: Change sysctl configs
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    sysctl_set: true
    reload: true
  with_dict:
    net.ipv4.ip_forward: 1
    net.ipv6.conf.all.forwarding: 1

- name: Enable and start tailscaled
  ansible.builtin.systemd:
    name: tailscaled.service
    enabled: true
    state: started

- name: Prompt for Tailscale auth key
  ansible.builtin.pause:
    echo: false
    prompt: |-
      ###### Tailscale - ACTION REQUIRED ######
      Generate a single-use, pre-authorized Tailscale auth key at https://login.tailscale.com/admin/settings/keys
      Enter Tailscale auth key
  register: _ts_auth_key

- name: Bring up Tailscale
  ansible.builtin.command:
    cmd: >-
      tailscale up
      --auth-key {{ _ts_auth_key.user_input }}
      --accept-dns=false
      --accept-routes=false
      --advertise-exit-node
      --advertise-routes={{ tailscale_advertise_routes }}
      --snat-subnet-routes=false
  changed_when: false
