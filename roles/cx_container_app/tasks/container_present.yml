---
- name: Create dirs for systemd units
  loop:
    - "{{ _systemd_container_dir }}"
    - ~/.config/systemd/user
  ansible.builtin.file:
    path: "{{ item }}"
    mode: "0750"
    owner: "{{ cx_container_app_user }}"
    group: "{{ cx_container_app_user }}"
    state: directory

- name: Deploy Quadlet units
  loop: "{{ _quadlet_files }}"
  ansible.builtin.template:
    src: "{{ (item | split('.'))[-1] }}.j2"
    dest: "{{ (_systemd_container_dir, item) | path_join }}"
    mode: "0640"
    owner: "{{ cx_container_app_user }}"
    group: "{{ cx_container_app_user }}"

- name: Pull container image
  containers.podman.podman_image:
    name: "{{ cx_container_app_image }}"
    force: true
    state: present

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true
    scope: "{{ _systemd_scope }}"

- name: Enable and restart systemd units
  loop: "{{ _systemd_units }}"
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
    scope: "{{ _systemd_scope }}"
    state: restarted
