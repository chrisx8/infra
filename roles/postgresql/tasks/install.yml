- name: Add PostgreSQL repo
  ansible.builtin.dnf:
    # yamllint disable-line rule:line-length
    name: https://download.postgresql.org/pub/repos/yum/reporpms/EL-{{ ansible_facts.distribution_major_version }}-x86_64/pgdg-redhat-repo-latest.noarch.rpm
    disable_gpg_check: true
    state: present

- name: Install PostgreSQL 14
  ansible.builtin.dnf:
    name:
      - postgresql14-contrib
      - postgresql14-server
    state: present
- name: Install dependencies for Ansible community.postgresql module
  ansible.builtin.dnf:
    name:
      - libpq-devel
      - python3-psycopg2
    state: present

- name: Initialize PostgreSQL database
  ansible.builtin.command: /usr/pgsql-14/bin/postgresql-14-setup initdb
  register: _postgresql_initdb
  changed_when: _postgresql_initdb.rc == 0
  failed_when: false

- name: Enable and start postgresql
  ansible.builtin.systemd:
    name: postgresql-14.service
    enabled: true
    state: started
