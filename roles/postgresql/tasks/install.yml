---
- name: Add pgdg-common repo
  ansible.builtin.yum_repository:
    name: pgdg-common
    description: PostgreSQL common RPMs
    baseurl: https://download.postgresql.org/pub/repos/yum/common/redhat/rhel-$releasever-$basearch
    gpgkey: https://download.postgresql.org/pub/repos/yum/RPM-GPG-KEY-PGDG
    gpgcheck: true
    repo_gpgcheck: true
- name: Add pgdg14 repo
  ansible.builtin.yum_repository:
    name: pgdg14
    description: PostgreSQL 14
    baseurl: https://download.postgresql.org/pub/repos/yum/14/redhat/rhel-$releasever-$basearch
    gpgkey: https://download.postgresql.org/pub/repos/yum/RPM-GPG-KEY-PGDG
    gpgcheck: true
    repo_gpgcheck: true

- name: Install PostgreSQL 14
  ansible.builtin.dnf:
    name:
      - postgresql14-contrib
      - postgresql14-server
    state: present
- name: Install dependencies for community.postgresql
  ansible.builtin.dnf:
    name:
      - python3-psycopg2
    state: present

- name: Initialize PostgreSQL database
  ansible.builtin.command: /usr/pgsql-14/bin/postgresql-14-setup initdb
  register: _postgresql_initdb
  changed_when: _postgresql_initdb.rc == 0
  failed_when: false

- name: Enable and start postgresql
  ansible.builtin.systemd:
    name: postgresql-14.service
    enabled: true
    state: started
