- name: Remove default user account (ubuntu) 1/3
  user:
    name: ubuntu
    state: absent
    remove: yes
- name: Remove default user account (debian) 2/3
  user:
    name: debian
    state: absent
    remove: yes
- name: Remove default user account (admin) 3/3
  user:
    name: admin
    state: absent
    remove: yes
- name: Remove Ubuntu motd config 1/3
  when: ansible_distribution == 'Ubuntu'
  file:
    path: /etc/update-motd.d/10-help-text
    state: absent
- name: Remove Ubuntu motd config 2/3
  when: ansible_distribution == 'Ubuntu'
  file:
    path: /etc/update-motd.d/50-motd-news
    state: absent
- name: Remove Ubuntu motd config 3/3
  when: ansible_distribution == 'Ubuntu'
  file:
    path: /etc/update-motd.d/51-cloudguest
    state: absent
- name: Remove Ubuntu motd package
  when: ansible_distribution == 'Ubuntu'
  apt:
    name: motd-news-config
    state: absent
    purge: yes
- name: Remove garbage packages
  apt:
    name: [joe, python, python-minimal, snapd, accountsservice, command-not-found, fwupd, lxcfs, 
           open-iscsi, open-vm-tools, os-prober, packagekit, plymouth, postfix, 
           software-properties-common, ssh-import-id, sosreport, telnet, ufw]
    state: absent
    autoremove: yes
    purge: yes
- name: Run apt dist-upgrade
  apt:
    update_cache: yes
    upgrade: dist

- name: apt autoremove
  apt:
    autoremove: yes
    purge: yes
- name: apt autoclean
  apt:
    autoclean: yes

- name: Install additional packages
  apt:
    name: [apt-transport-https, ca-certificates, curl, dnsutils, fail2ban, git, gnupg, psmisc, vim]
    state: latest
- name: Limit systemd-journald
  lineinfile:
    dest: "/etc/systemd/journald.conf"
    regex: "SystemMaxUse="
    line: "SystemMaxUse=10M"
- name: Configure vim
  copy:
    src: vimrc
    dest: /etc/vim/vimrc
    mode: 0644
- name: Check configuration existence
  stat:
    path: /etc/ssh/ssh_host_dsa_key
  register: configured
- name: Configure bashrc
  when: configured.stat.exists
  lineinfile:
    dest: "/etc/bash.bashrc"
    line: "
    # Installed by Ansible\n
    export EDITOR=vim\n
    alias dfh='df -h -x tmpfs -x overlay'\n
    "
- name: Configure OpenSSH client
  copy:
    src: ssh_config
    dest: /etc/ssh/ssh_config
    mode: 0644
- name: Configure OpenSSH server
  copy:
    src: sshd_config
    dest: /etc/ssh/sshd_config
    mode: 0644
- name: Remove unsupported SSH host keys
  shell: "rm -f /etc/ssh/ssh_host_*dsa_key*"
- name: Restart OpenSSH server (sshd)
  systemd:
    name: sshd
    state: restarted
    daemon_reload: yes
- name: Configure crontab
  cron:
    name: MAILTO
    env: true
    job: ""
- name: Set timezone (Linux systemd)
  command: "timedatectl set-timezone {{ hostvars[ansible_hostname].timezone }}"
  when: hostvars[ansible_hostname].timezone is defined
- name: Update /etc/hosts with private IP addresses
  lineinfile:
    dest: /etc/hosts
    regexp: '.*{{ item }}$'
    line: "{{ hostvars[item].private_ip }} {{ item }}"
    state: present
  when: hostvars[item].private_ip is defined
  with_items: "{{ groups.all }}"
