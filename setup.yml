- name: Set up Proxmox VE
  hosts: proxmox
  become: true
  gather_subset:
    - virtualization_role
    - virtualization_type
  roles:
    - sys/proxmox
    - inf/tailscale

- name: Set up all guests
  hosts: guests
  become: true
  gather_subset: min
  roles:
    - sys/base

- name: Set up Pi-hole instance
  hosts: pihole
  become: true
  gather_facts: false
  roles:
    - inf/apache_php
    - app/pihole

- name: Set up PostgreSQL server
  hosts: db-postgres
  become: true
  gather_subset: 'min'
  roles:
    - inf/postgresql

- name: Set up storage server
  hosts: storage
  become: true
  gather_subset: 'min'
  roles:
    - inf/cockpit
    - app/file_shares
    - app/jellyfin

- name: Set up containers
  hosts: web-container
  become: true
  gather_subset: 'virtualization_type'
  roles:
    - sys/podman
    - app/containers

- name: Set up Apache + PHP
  hosts: web-php
  become: true
  gather_subset: 'min'
  vars:
    php_composer: true
  roles:
    - inf/apache_php
    - inf/postfix
    - app/nextcloud
    - app/tinynet_launcher
